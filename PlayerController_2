using UnityEngine;

[RequireComponent(typeof(Collider2D))]
[RequireComponent(typeof(Rigidbody2D))] // Rigidbody2D í•„ìˆ˜!
public class Playercontroller1 : MonoBehaviour
{
    // --- ë“œë˜ê·¸ ì…ë ¥ ë³€ìˆ˜
    private Vector2 dragStartPos;
    private Vector2 dragEndPos;
    private bool isDragging = false;

    // --- ë¬¼ë¦¬ ë° ì´ë™ ë³€ìˆ˜
    private Rigidbody2D rb;
    private bool isMoving = false; // ì´ë™ ì‹œì‘ ì—¬ë¶€

    [Header("ë°œì‚¬ ê´€ë ¨ ì„¤ì •")]
    public float launchPower = 2f;
    public float dragSensitivity = 1f;
    public float maxSpeed = 10f; // í„°ë„ë§ ë°©ì§€ ë³´ì¡°ìš© ìµœëŒ€ ì†ë„ ì œí•œ

    [Header("ë°˜ì‚¬ ê´€ë ¨ ì„¤ì •")]
    public int maxBounceCount = 3;
    private int currentBounceCount;

    [Header("ëª©í‘œë¬¼")]
    public Transform goal;
    public float goalRadius = 0.5f;

    // --- ì´ˆê¸° ìœ„ì¹˜ ì €ì¥
    private readonly Vector2 startPosition = new Vector2(-0.01f, -4.6f);

    void Start()
    {
        rb = GetComponent<Rigidbody2D>();

        // Rigidbody2D ì„¤ì • (í„°ë„ë§ ë°©ì§€ í•µì‹¬)
        rb.gravityScale = 0f;
        rb.freezeRotation = true;
        // Continuous ëª¨ë“œëŠ” ê³ ì† ì´ë™ ì‹œ í„°ë„ë§ì„ ì¤„ì—¬ì¤ë‹ˆë‹¤.
        rb.collisionDetectionMode = CollisionDetectionMode2D.Continuous;

        ResetPlayer(); // ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ Startì—ì„œ í˜¸ì¶œ
    }

    void Update()
    {
        HandleInput();

        // Rí‚¤ ì…ë ¥ ì²´í¬ â†’ ìœ„ì¹˜ ì´ˆê¸°í™”
        if (Input.GetKeyDown(KeyCode.R))
        {
            ResetPlayer();
        }
    }

    void FixedUpdate()
    {
        // isMoving ìƒíƒœë¥¼ rb.velocityë¡œ ì—…ë°ì´íŠ¸
        isMoving = rb.linearVelocity.sqrMagnitude > 0.001f;

        if (!isMoving) return;

        // ì†ë„ ì œí•œ (í„°ë„ë§ ë°©ì§€ ë³´ì¡°)
        if (rb.linearVelocity.magnitude > maxSpeed)
        {
            rb.linearVelocity = rb.linearVelocity.normalized * maxSpeed;
        }

        CheckGoal(); // ëª©í‘œë¬¼ ì²´í¬
    }

    private void OnCollisionEnter2D(Collision2D collision)
    {
        // isMoving ìƒíƒœê°€ ì•„ë‹ˆë©´ ì¶©ëŒ ì²˜ë¦¬ ë¬´ì‹œ (ë°œì‚¬ ì „)
        if (!isMoving) return;

        // ì¶©ëŒ ì§€ì ì˜ ë²•ì„  ë²¡í„° ê°€ì ¸ì˜¤ê¸°
        Vector2 normal = collision.contacts[0].normal;

        // Wall íƒœê·¸ ì²˜ë¦¬
        if (collision.collider.CompareTag("Wall"))
        {
            if (currentBounceCount > 0)
            {
                // â­ ì½”ë“œë¡œ ë°˜ì‚¬ ê°•ì œ êµ¬í˜„ â­
                rb.linearVelocity = Vector2.Reflect(rb.linearVelocity, normal);

                // â­ ìµœì†Œ ì†ë„ ë³´ì • â€” ì¶©ëŒ í›„ ë©ˆì¶°ë²„ë¦¬ëŠ” ë¬¸ì œ ë°©ì§€
                if (rb.linearVelocity.magnitude < 1.0f)
                {
                    rb.linearVelocity = rb.linearVelocity.normalized * 1.0f;
                }

                currentBounceCount--;
                //Debug.Log("ë²½ ë°˜ì‚¬ (Code Reflect). ë‚¨ì€ íšŸìˆ˜: " + currentBounceCount);
            }
            else
            {
                // íŠ•ê¹€ íšŸìˆ˜ ì†Œì§„ â†’ ë©ˆì¶¤ ë° ì‹¤íŒ¨ ì²˜ë¦¬
                StopMovement();
                //GameManager.Instance.OnLose();
            }
        }
        // InvisibleWall íƒœê·¸ ì²˜ë¦¬
        else if (collision.collider.CompareTag("InvisibleWall"))
        {
            // InvisibleWallì€ 'ë°˜ì‚¬ íšŸìˆ˜ê°€ 0ì¼ ë•Œ' ë©ˆì¶¤ ë° ì‹¤íŒ¨
            if (currentBounceCount == 0)
            {
                StopMovement();
                //GameManager.Instance.OnLose();
            }
            else
            {
                // íšŸìˆ˜ê°€ ë‚¨ì•˜ìœ¼ë©´ ì¶©ëŒ ê°ì§€ í›„ì—ë„ ê·¸ëƒ¥ í†µê³¼ (ë°˜ì‚¬ ì—†ìŒ)
            }
        }
        // Goal íƒœê·¸ ì²˜ë¦¬
        else if (collision.collider.CompareTag("Goal"))
        {
            var health = collision.collider.GetComponent<HealthWithUI2D>();

            if (goal == null)
            {
                Debug.LogError("GoalHealth ìŠ¤í¬ë¦½íŠ¸ê°€ Goalì— ì—†ìŒ!");
                return;
            }

            health.TakeDamage(1); // UI + HP ê°ì†Œ + Death ì´ë²¤íŠ¸ í˜¸ì¶œ

            // ğŸ”µ Goalì˜ HPê°€ ì´ë¯¸ 0 â†’ ì¦‰ì‹œ ìŠ¹ë¦¬
            if (goal.IsDead)
            {
                StopMovement();
                GameManager.Instance.OnWin();
                return;
            }

            // ğŸ”µ ì•„ì§ HPê°€ ë‚¨ì•„ ìˆëŠ” ê²½ìš° â†’ ëŒ€ë¯¸ì§€
            goal.TakeDamage(1);  // íƒ„í™˜ ëŒ€ë¯¸ì§€ = 1 (ì›í•˜ë©´ ë³€ê²½ ê°€ëŠ¥)

            // ëŒ€ë¯¸ì§€ ì´í›„ ì£½ì—ˆìœ¼ë©´ ìŠ¹ë¦¬
            if (goal.IsDead)
            {
                StopMovement();
                GameManager.Instance.OnWin();
            }
            else
            {
                Debug.Log("Goal í”¼ê²©í–ˆì§€ë§Œ ì•„ì§ ì‚´ì•„ìˆìŒ.");
            }
        }
    }

    // í”Œë ˆì´ì–´ ì´ˆê¸°í™” í•¨ìˆ˜
    private void ResetPlayer()
    {
        rb.position = startPosition;
        rb.linearVelocity = Vector2.zero;
        isMoving = false;
        isDragging = false;
        currentBounceCount = maxBounceCount;
    }

    // ì´ë™ ì •ì§€ ì²˜ë¦¬
    private void StopMovement()
    {
        rb.linearVelocity = Vector2.zero;
        isMoving = false;
    }

    private void HandleInput()
    {
        if (isMoving) return; // ì›€ì§ì´ëŠ” ì¤‘ì—ëŠ” ì…ë ¥ ë¬´ì‹œ

        if (Input.GetMouseButtonDown(0))
        {
            dragStartPos = Camera.main.ScreenToWorldPoint(Input.mousePosition);
            isDragging = true;
            currentBounceCount = maxBounceCount; // ë“œë˜ê·¸ ì‹œì‘ ì‹œ íšŸìˆ˜ ì´ˆê¸°í™”
        }

        if (Input.GetMouseButtonUp(0) && isDragging)
        {
            dragEndPos = Camera.main.ScreenToWorldPoint(Input.mousePosition);
            Vector2 launchDir = (dragStartPos - dragEndPos).normalized;
            float rawPower = (dragStartPos - dragEndPos).magnitude;

            // ë°œì‚¬ í˜ ê³„ì‚° (ìµœëŒ€ ì†ë„ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ì œí•œ)
            float finalPower = Mathf.Clamp(rawPower * launchPower * dragSensitivity, 0f, maxSpeed);

            // Rigidbodyì— ì†ë„ ì ìš©
            rb.linearVelocity = launchDir * finalPower;
            isDragging = false;
        }
    }

    private void CheckGoal()
    {
        if (goal == null) return;

        // ëª©í‘œë¬¼ ë°˜ê²½ ì²´í¬ (Goal Collider ì‚¬ìš© ì•ˆí•˜ê³  ë²”ìœ„ ì²´í¬)
        float dist = Vector2.Distance(rb.position, goal.position);
        if (dist < goalRadius)
        {
            if (currentBounceCount == 0)
            {
                StopMovement();
                GameManager.Instance.OnWin();
            }
            // íšŸìˆ˜ê°€ ë‚¨ì•˜ìœ¼ë©´ ì•„ì§ ìŠ¹ë¦¬ ì¡°ê±´ì´ ì•„ë‹ˆë¯€ë¡œ ê³„ì† ì§„í–‰
        }
    }
}
